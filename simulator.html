<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Animal Science — Licensure Mock Exam</title>
<meta name="description" content="Interactive 100-question animal science mock exam — import JSON, timer, review mode, save/load, export results."/>
<style>
  :root{
    --bg:#f6fbf6; --panel:#ecf7ec; --card:#ffffff;
    --primary:#2e7d32; --muted:#6b7280; --accent:#ffb300; --danger:#ef4444;
    --ok:#16a34a;
    --radius:12px; --shadow: 0 6px 18px rgba(18,52,20,0.06);
    --maxw:1200px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#06361a;background:linear-gradient(180deg,#f0faf0,#eaf6ea);-webkit-font-smoothing:antialiased}
  .app{max-width:var(--maxw);margin:18px auto;padding:18px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--primary),#66bb6a);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px;box-shadow:var(--shadow)}
  h1{margin:0;font-size:20px}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:13px;color:var(--muted)}
  .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
  .layout{display:grid;grid-template-columns:260px 1fr;gap:12px}
  /* Sidebar */
  aside{display:flex;flex-direction:column;gap:12px}
  .sidebar-top{display:flex;gap:8px;align-items:center}
  #qGrid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;max-height:520px;overflow:auto;padding:6px}
  .qnum{background:linear-gradient(180deg,#f8fffb,#f0fff0);border-radius:8px;padding:8px;text-align:center;cursor:pointer;border:1px solid rgba(10,60,20,0.05);font-weight:600}
  .qnum.current{outline:2px solid rgba(46,125,50,0.18)}
  .qnum.answered{background:linear-gradient(90deg,#16a34a,#059669);color:#fff}
  .qnum.correct{background:#16a34a;color:white}
  .qnum.wrong{background:#ef4444;color:white}
  /* Main */
  main{display:flex;flex-direction:column;gap:12px}
  .meta{display:flex;align-items:center;gap:12px}
  #timer{font-weight:700;color:var(--card);background:linear-gradient(90deg,var(--accent),#ffd86b);padding:6px 10px;border-radius:8px}
  #progressWrap{flex:1}
  .progress{height:10px;background:rgba(0,0,0,0.06);border-radius:999px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--primary),#66bb6a);width:0%}
  .question-card{padding:18px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#f7fff7);box-shadow:var(--shadow)}
  #questionText{font-size:18px;margin-bottom:12px}
  #choices{display:flex;flex-direction:column;gap:10px}
  .choice{background:transparent;border:2px solid rgba(6,54,26,0.06);padding:12px;border-radius:10px;cursor:pointer;text-align:left;display:flex;gap:12px;align-items:center}
  .choice:hover{transform:translateY(-2px)}
  .choice .letter{width:34px;height:34px;border-radius:8px;background:rgba(6,54,26,0.06);display:flex;align-items:center;justify-content:center;font-weight:700}
  .choice.selected{background:linear-gradient(90deg,#e6f8ea,#d1f0d9);border-color:rgba(6,54,26,0.12)}
  .choice.correct{background:linear-gradient(90deg,#16a34a33,#16a34a22);border-color:rgba(22,163,74,0.3)}
  .choice.wrong{background:linear-gradient(90deg,#ef444433,#ef444422);border-color:rgba(239,68,68,0.25)}
  .nav{display:flex;gap:8px;align-items:center;margin-top:12px}
  button.btn{background:var(--primary);color:white;padding:10px 12px;border-radius:8px;border:0;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(6,54,26,0.06);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
  .tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  footer.small{font-size:13px;color:var(--muted);margin-top:10px}
  /* result modal */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(3,20,10,0.45);z-index:60}
  .modal .box{background:white;padding:22px;border-radius:12px;min-width:320px;max-width:90%;text-align:center}
  .result-big{font-size:22px;font-weight:800;color:var(--primary);margin:8px 0}
  /* responsive */
  @media(max-width:980px){
    .layout{grid-template-columns:1fr;gap:10px}
    aside{order:2}
    .brand h1{font-size:18px}
    #qGrid{grid-template-columns:repeat(10,1fr)}
  }
  /* Hide review button as review before submit is disabled */
  #reviewBtn {
    display: none !important;
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">AS</div>
        <div>
          <h1>Animal Science — Mock Licensure Exam</h1>
          <div class="small">Prepared for licensure review — import your JSON to begin</div>
        </div>
      </div>

      <div class="controls">
        <div class="small">Answered: <strong id="answeredCount">0</strong>/<strong id="totalQ">0</strong></div>
        <div id="timer" title="Time remaining">--:--:--</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="saveBtn" class="ghost" title="Save progress (S)">Save</button>
          <button id="loadBtn" class="ghost" title="Load progress (L)">Load</button>
          <label class="ghost" style="padding:6px;border-radius:8px;cursor:pointer">
            <input id="fileInput" type="file" accept="application/json" style="display:none">Import JSON
          </label>
        </div>
      </div>
    </header>

    <div class="meta" style="margin-bottom:8px">
      <div id="examTitle" class="small">Exam: Animal Science</div>
      <div id="progressWrap">
        <div class="progress"><i id="progressFill"></i></div>
      </div>
      <div class="tools">
        <label class="small">Timer (mins): <input id="timerInput" type="number" value="60" min="1" style="width:70px;margin-left:6px"></label>
        <label class="small"><input id="autoSave" type="checkbox"> Auto-save</label>
        <button id="randomizeBtn" class="ghost">Randomize Qs</button>
        <button id="randomChoicesBtn" class="ghost">Randomize Choices</button>
        <button id="exportJsonBtn" class="ghost">Export JSON</button>
        <button id="exportCsvBtn" class="ghost">Export CSV</button>
      </div>
    </div>

    <div class="layout">
      <!-- SIDEBAR -->
      <aside class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">Navigator</div>
          <div class="small"><button id="clearAnswers" class="ghost" title="Clear all answers">Clear</button></div>
        </div>
        <div id="qGrid" aria-label="Question grid"></div>

        <div style="margin-top:12px">
          <div class="small">Options</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="reviewBtn" class="ghost">Review answers</button>
            <button id="submitBtn" class="btn">Submit exam</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Import/Export</div>
          <div style="margin-top:8px" class="small">You can import a JSON file formatted like: <code>[{"question":"...","choices":["A","B","C","D"],"answer":0},...]</code></div>
        </div>
      </aside>

      <!-- MAIN -->
      <main>
        <div class="question-card card" id="questionCard">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div>
              <div class="small">Question <strong id="qIndex">1</strong> / <strong id="totalQs">0</strong></div>
              <div id="questionText">Load a JSON file to start the exam.</div>
            </div>
            <div class="small" style="text-align:right">Keyboard: ←/→ to navigate • 1–4 to answer</div>
          </div>

          <div id="choices" style="margin-top:14px"></div>

          <div class="nav">
            <button id="prevBtn" class="ghost">← Previous</button>
            <button id="nextBtn" class="ghost">Next →</button>
            <div style="margin-left:auto;display:flex;gap:8px">
              <button id="saveLocalBtn" class="ghost">Save file</button>
              <button id="resetBtn" class="ghost">Reset exam</button>
            </div>
          </div>
        </div>

        <footer class="small">Tip: Use the <strong>Import JSON</strong> button to upload your exam file. The page auto-saves if enabled.</footer>
      </main>
    </div>
  </div>

  <!-- Modals -->
  <div id="resultModal" class="modal hidden" style="display:none">
    <div class="box">
      <h3>Exam Results</h3>
      <div class="result-big" id="scoreText">0 / 0</div>
      <div class="small" id="percentText">0%</div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button id="closeResult" class="ghost">Close</button>
      </div>
    </div>
  </div>

<script>
/* === App state === */
let QUESTIONS = [];            // array of {question, choices[], answer}
let USER = [];                 // array user answers (index or null)
let CURRENT = 0;
let TOTAL = 0;
let TIMER = null;
let reviewMode = false;        // review mode disabled before submission and no review button

/* --- DOM refs --- */
const qGrid = document.getElementById('qGrid');
const qIndexEl = document.getElementById('qIndex');
const totalQsEl = document.getElementById('totalQs');
const questionText = document.getElementById('questionText');
const choicesEl = document.getElementById('choices');
const answeredCountEl = document.getElementById('answeredCount');
const totalQEl = document.getElementById('totalQ');
const progressFill = document.getElementById('progressFill');
const timerEl = document.getElementById('timer');
const resultModal = document.getElementById('resultModal');
const scoreText = document.getElementById('scoreText');
const percentText = document.getElementById('percentText');
const submitBtn = document.getElementById('submitBtn');
const reviewBtn = document.getElementById('reviewBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const clearAnswersBtn = document.getElementById('clearAnswers');
const saveBtn = document.getElementById('saveBtn');
const loadBtn = document.getElementById('loadBtn');
const fileInput = document.getElementById('fileInput');
const saveLocalBtn = document.getElementById('saveLocalBtn');
const resetBtn = document.getElementById('resetBtn');
const closeResultBtn = document.getElementById('closeResult');
const timerInput = document.getElementById('timerInput');
const autoSaveCheckbox = document.getElementById('autoSave');
const randomizeBtn = document.getElementById('randomizeBtn');
const randomChoicesBtn = document.getElementById('randomChoicesBtn');
const exportJsonBtn = document.getElementById('exportJsonBtn');
const exportCsvBtn = document.getElementById('exportCsvBtn');

/* --- Helpers --- */
function safeText(s){ return String(s||'').replace(/\s+$/,'').trim(); }
function formatTime(s){
  if (s<0) s=0;
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
  return (h>0? String(h).padStart(2,'0')+':' : '') + String(m).padStart(2,'0') + ':' + String(sec).padStart(2,'0');
}
function updateAnsweredCount(){ 
  const count = USER.filter(x=>x!==null).length;
  answeredCountEl.textContent = count;
  totalQEl.textContent = TOTAL;
  document.getElementById('totalQs').textContent = TOTAL;
  document.getElementById('answeredCount').textContent = count;
  document.getElementById('totalQ').textContent = TOTAL;
  progressFill.style.width = TOTAL? Math.round((count/TOTAL)*100) + '%' : '0%';
}

/* --- Build grid --- */
function buildGrid(){
  qGrid.innerHTML = '';
  for(let i=0;i<TOTAL;i++){
    const btn = document.createElement('button');
    btn.className = 'qnum';
    btn.textContent = i+1;
    btn.dataset.i = i;
    btn.addEventListener('click', ()=>{ renderQuestion(i);});
    qGrid.appendChild(btn);
  }
  refreshGrid();
}
function refreshGrid(){
  const nodes = qGrid.querySelectorAll('.qnum');
  nodes.forEach(n=>{
    const i = Number(n.dataset.i);
    n.classList.toggle('current', i===CURRENT);
    n.classList.toggle('answered', USER[i] !== null);
    n.classList.remove('correct','wrong');
    // No review highlights before submit, no review button, so skip
  });
}

/* --- Render question --- */
function renderQuestion(idx){
  if (idx < 0) idx = 0;
  if (idx >= TOTAL) idx = TOTAL-1;
  CURRENT = idx;
  qIndexEl.textContent = idx+1;
  questionText.textContent = safeText(QUESTIONS[idx]?.question || '(no question)');
  choicesEl.innerHTML = '';
  const choices = QUESTIONS[idx]?.choices || [];
  choices.forEach((c,i)=>{
    const el = document.createElement('div');
    el.className = 'choice';
    if (!reviewMode && USER[idx] === i) el.classList.add('selected');
    // No review highlight, so no correct/wrong classes applied
    el.innerHTML = `<div class="letter">${String.fromCharCode(65+i)}</div><div style="flex:1">${c}</div>`;
    if (!reviewMode){
      el.tabIndex = 0;
      el.addEventListener('click', ()=> selectAnswer(idx,i));
      el.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') selectAnswer(idx,i); });
    } else {
      el.setAttribute('aria-disabled','true');
    }
    choicesEl.appendChild(el);
  });
  refreshGrid();
  updateAnsweredCount();
}

/* --- Answer selection --- */
function selectAnswer(qIdx, cIdx){
  if (reviewMode) return;
  USER[qIdx] = cIdx;
  saveProgressToLocal(false);
  renderQuestion(qIdx);
}

/* --- Loading JSON --- */
function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const parsed = JSON.parse(reader.result);
      loadQuestionsFromArray(parsed);
      alert('Imported ' + (parsed.length||0) + ' questions.');
    }catch(e){ alert('Invalid JSON file.'); }
  };
  reader.readAsText(file);
}
function loadQuestionsFromArray(arr){
  QUESTIONS = arr.map((q,idx)=>({
    question: q.question || q.prompt || `Question ${idx+1}`,
    choices: Array.isArray(q.choices) ? q.choices.slice(0,4) : [],
    answer: (typeof q.answer === 'number' ? q.answer : (q.answer === null ? null : (typeof q.correct === 'number'? q.correct : null)))
  }));
  QUESTIONS.forEach((q,i)=>{
    // Ensure answer is valid index
    if(q.answer === null || q.answer >= q.choices.length || q.answer < 0) q.answer = null;
  });
  TOTAL = QUESTIONS.length;
  USER = new Array(TOTAL).fill(null);
  reviewMode = false;
  CURRENT = 0;
  renderQuestion(0);
  buildGrid();
  updateAnsweredCount();
  submitBtn.disabled = false;
  prevBtn.disabled = false;
  nextBtn.disabled = false;
  // Reset timer if you want
}

/* --- Submit exam --- */
function submitExam(){
  if(reviewMode) return;
  const unanswered = USER.filter(x=>x===null).length;
  if(unanswered>0){
    if(!confirm(`You have ${unanswered} unanswered questions. Submit anyway?`)) return;
  }
  if(!confirm('Submit exam? You will not be able to change your answers after submitting.')) return;

  reviewMode = true;

  // Disable buttons that allow changes
  submitBtn.disabled = true;
  prevBtn.disabled = true;
  nextBtn.disabled = true;
  clearAnswersBtn.disabled = true;

  // Calculate score
  let correct = 0;
  for(let i=0; i<TOTAL; i++){
    if(USER[i] === QUESTIONS[i].answer) correct++;
  }

  // Show result modal
  scoreText.textContent = `${correct} / ${TOTAL}`;
  percentText.textContent = TOTAL ? ((correct/TOTAL)*100).toFixed(2) + '%' : '0%';
  resultModal.style.display = 'flex';

  // Render current question with review mode (highlight correct/wrong)
  renderReviewQuestion(CURRENT);

  // Also update grid colors
  updateGridForReview();
}

/* --- Render review mode for question --- */
function renderReviewQuestion(idx){
  if(idx < 0) idx = 0;
  if(idx >= TOTAL) idx = TOTAL - 1;
  CURRENT = idx;
  qIndexEl.textContent = idx + 1;
  questionText.textContent = safeText(QUESTIONS[idx]?.question || '(no question)');
  choicesEl.innerHTML = '';
  const choices = QUESTIONS[idx]?.choices || [];
  choices.forEach((c,i)=>{
    const el = document.createElement('div');
    el.className = 'choice';
    if(USER[idx] === i && i === QUESTIONS[idx].answer){
      el.classList.add('correct');
    } else if(USER[idx] === i && i !== QUESTIONS[idx].answer){
      el.classList.add('wrong');
    }
    else if(i === QUESTIONS[idx].answer){
      el.classList.add('correct');
    }
    el.innerHTML = `<div class="letter">${String.fromCharCode(65+i)}</div><div style="flex:1">${c}</div>`;
    el.setAttribute('aria-disabled','true');
    choicesEl.appendChild(el);
  });
  refreshGrid();
  updateAnsweredCount();
}

/* --- Update grid on review --- */
function updateGridForReview(){
  const nodes = qGrid.querySelectorAll('.qnum');
  nodes.forEach(n=>{
    const i = Number(n.dataset.i);
    n.classList.remove('current','answered','correct','wrong');
    if(i === CURRENT) n.classList.add('current');
    if(USER[i] !== null) n.classList.add('answered');
    if(USER[i] !== null && QUESTIONS[i].answer !== null){
      if(USER[i] === QUESTIONS[i].answer){
        n.classList.add('correct');
      } else {
        n.classList.add('wrong');
      }
    }
  });
}

/* --- Navigation --- */
prevBtn.addEventListener('click', ()=> {
  if(CURRENT > 0) {
    CURRENT--;
    reviewMode ? renderReviewQuestion(CURRENT) : renderQuestion(CURRENT);
  }
});
nextBtn.addEventListener('click', ()=>{
  if(CURRENT < TOTAL-1) {
    CURRENT++;
    reviewMode ? renderReviewQuestion(CURRENT) : renderQuestion(CURRENT);
  }
});
qGrid.addEventListener('click', (e)=>{
  if(e.target && e.target.matches('button.qnum')){
    const idx = Number(e.target.dataset.i);
    CURRENT = idx;
    reviewMode ? renderReviewQuestion(CURRENT) : renderQuestion(CURRENT);
  }
});

/* --- Keyboard navigation --- */
document.addEventListener('keydown', (e)=>{
  if(reviewMode) return; // no changes allowed
  if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return; // ignore typing

  if(e.key === 'ArrowLeft' || e.key === 'ArrowUp'){
    e.preventDefault();
    if(CURRENT > 0) renderQuestion(CURRENT-1);
  }
  else if(e.key === 'ArrowRight' || e.key === 'ArrowDown'){
    e.preventDefault();
    if(CURRENT < TOTAL-1) renderQuestion(CURRENT+1);
  }
  else if(['1','2','3','4'].includes(e.key)){
    e.preventDefault();
    const choiceIndex = Number(e.key)-1;
    if(CURRENT >= 0 && CURRENT < TOTAL){
      if(QUESTIONS[CURRENT].choices.length > choiceIndex){
        selectAnswer(CURRENT, choiceIndex);
      }
    }
  }
  else if(e.key.toLowerCase() === 's' && e.ctrlKey){
    e.preventDefault();
    saveProgressToLocal(true);
  }
});

/* --- Clear all answers --- */
clearAnswersBtn.addEventListener('click', ()=>{
  if(!confirm('Clear all your answers?')) return;
  USER.fill(null);
  reviewMode = false;
  CURRENT = 0;
  submitBtn.disabled = false;
  prevBtn.disabled = false;
  nextBtn.disabled = false;
  clearAnswersBtn.disabled = false;
  renderQuestion(0);
  buildGrid();
  updateAnsweredCount();
});

/* --- Submit button --- */
submitBtn.addEventListener('click', submitExam);

/* --- Result modal --- */
closeResultBtn.addEventListener('click', ()=>{
  resultModal.style.display = 'none';
});

/* --- Save/Load progress from localStorage --- */
function saveProgressToLocal(alertUser=true){
  if(TOTAL === 0) return;
  const data = {
    questions: QUESTIONS,
    userAnswers: USER,
    current: CURRENT,
    timestamp: Date.now()
  };
  try {
    localStorage.setItem('mockExamData', JSON.stringify(data));
    if(alertUser) alert('Progress saved.');
  } catch(e){
    alert('Failed to save progress.');
  }
}
function loadProgressFromLocal(){
  try {
    const data = JSON.parse(localStorage.getItem('mockExamData'));
    if(data && Array.isArray(data.questions) && Array.isArray(data.userAnswers)){
      QUESTIONS = data.questions;
      USER = data.userAnswers;
      TOTAL = QUESTIONS.length;
      CURRENT = data.current || 0;
      reviewMode = false;
      submitBtn.disabled = false;
      prevBtn.disabled = false;
      nextBtn.disabled = false;
      clearAnswersBtn.disabled = false;
      buildGrid();
      renderQuestion(CURRENT);
      updateAnsweredCount();
      alert('Progress loaded.');
      return true;
    }
  } catch(e){}
  alert('No saved progress found.');
  return false;
}
saveBtn.addEventListener('click', ()=>saveProgressToLocal(true));
loadBtn.addEventListener('click', loadProgressFromLocal);

/* --- Import JSON --- */
fileInput.addEventListener('change', e=>{
  if(e.target.files.length>0){
    importJSONFile(e.target.files[0]);
  }
  e.target.value = '';
});

/* --- Save as JSON file --- */
saveLocalBtn.addEventListener('click', ()=>{
  if(TOTAL === 0) {
    alert('No exam loaded');
    return;
  }
  const data = {
    questions: QUESTIONS,
    userAnswers: USER
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'mock-exam-progress.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* --- Reset exam --- */
resetBtn.addEventListener('click', ()=>{
  if(confirm('Reset the exam and clear all data?')){
    QUESTIONS = [];
    USER = [];
    CURRENT = 0;
    TOTAL = 0;
    reviewMode = false;
    qGrid.innerHTML = '';
    questionText.textContent = 'Load a JSON file to start the exam.';
    choicesEl.innerHTML = '';
    updateAnsweredCount();
    submitBtn.disabled = true;
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    clearAnswersBtn.disabled = false;
  }
});

/* --- Export JSON --- */
exportJsonBtn.addEventListener('click', ()=>{
  if(TOTAL===0) {
    alert('No exam loaded');
    return;
  }
  const out = JSON.stringify(QUESTIONS, null, 2);
  const blob = new Blob([out], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'mock-exam-questions.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* --- Export CSV --- */
exportCsvBtn.addEventListener('click', ()=>{
  if(TOTAL===0){
    alert('No exam loaded');
    return;
  }
  let csv = 'Question,Choice A,Choice B,Choice C,Choice D,Answer\n';
  QUESTIONS.forEach(q=>{
    const escaped = str=>`"${(q.question||'').replace(/"/g,'""')}"`;
    let line = escaped(q.question);
    for(let i=0;i<4;i++){
      line += ',' + `"${(q.choices[i]||'').replace(/"/g,'""')}"`;
    }
    line += ',' + (typeof q.answer === 'number' ? String.fromCharCode(65 + q.answer) : '');
    csv += line + '\n';
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'mock-exam-questions.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* --- Randomize questions --- */
randomizeBtn.addEventListener('click', ()=>{
  if(confirm('Randomize questions order?')){
    for(let i=QUESTIONS.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [QUESTIONS[i], QUESTIONS[j]] = [QUESTIONS[j], QUESTIONS[i]];
      [USER[i], USER[j]] = [USER[j], USER[i]];
    }
    CURRENT = 0;
    buildGrid();
    renderQuestion(0);
  }
});
/* --- Randomize choices --- */
randomChoicesBtn.addEventListener('click', ()=>{
  if(confirm('Randomize choices order within each question?')){
    QUESTIONS.forEach((q,i)=>{
      const arr = q.choices.map((ch,idx)=>({choice: ch, idx}));
      for(let i=arr.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      q.choices = arr.map(a=>a.choice);
      // Fix answer index to new position
      if(q.answer !== null){
        const origAnswer = arr.findIndex(a=>a.idx === q.answer);
        q.answer = origAnswer === -1 ? null : origAnswer;
      }
    });
    renderQuestion(CURRENT);
    buildGrid();
  }
});

/* --- Auto-save --- */
autoSaveCheckbox.addEventListener('change', e=>{
  if(e.target.checked){
    saveProgressToLocal(false);
  }
});

/* --- Timer --- */
let timerSeconds = 3600; // default 1hr
timerInput.addEventListener('change', e=>{
  const val = Number(e.target.value);
  if(val > 0){
    timerSeconds = val * 60;
    resetTimer();
  }
});
function resetTimer(){
  if(TIMER) clearInterval(TIMER);
  timerEl.textContent = formatTime(timerSeconds);
  TIMER = setInterval(()=>{
    timerSeconds--;
    timerEl.textContent = formatTime(timerSeconds);
    if(timerSeconds<=0){
      clearInterval(TIMER);
      alert('Time is up! Submitting exam automatically.');
      submitExam();
    }
  },1000);
}
// Start timer initially
resetTimer();

/* --- Initialization --- */
function init(){
  // Disable buttons that require questions before loaded
  submitBtn.disabled = true;
  prevBtn.disabled = true;
  nextBtn.disabled = true;
  clearAnswersBtn.disabled = false;
  updateAnsweredCount();
}
init();
</script>
</body>
</html>
